<dqm4hep>

  <global>

    <!-- Shared memory driver. Read raw data source buffers in shared memory -->
    <shmdriver directory="/dev/shm/levbdim">
      <datasources>
	<!-- detectors : SDHCAL = 100 SiWECal = 1100 Cherenkov = 100 (SDHCAL 
	     DIF) -->

	<!-- Cherenkov source as a SDHCAL DIF -->
	<source detector="100" id="3"/>
	
	<!-- SDHCAL sources (144 - 1 DIFs) -->
	<source detector="100" id="181"/>
	<source detector="100" id="94"/>
	<source detector="100" id="30"/>
	<source detector="100" id="117"/>
	<source detector="100" id="149"/>
	<source detector="100" id="115"/>
	<source detector="100" id="122"/>
	<source detector="100" id="123"/>
	<source detector="100" id="130"/>
	<source detector="100" id="129"/>
	<source detector="100" id="118"/>
	<source detector="100" id="119"/>
	<source detector="100" id="164"/>
	<source detector="100" id="152"/>
	<source detector="100" id="151"/>
	<source detector="100" id="74"/>
	<source detector="100" id="61"/>
	<source detector="100" id="75"/>
	<source detector="100" id="156"/>
	<source detector="100" id="111"/>
	<source detector="100" id="110"/>
	<source detector="100" id="102"/>
	<source detector="100" id="177"/>
	<source detector="100" id="103"/>
	<source detector="100" id="133"/>
	<source detector="100" id="136"/>
	<source detector="100" id="134"/>
	<source detector="100" id="128"/>
	<source detector="100" id="120"/>
	<source detector="100" id="121"/>
	<source detector="100" id="65"/>
	<source detector="100" id="64"/>
	<source detector="100" id="58"/>
	<source detector="100" id="148"/>
	<source detector="100" id="72"/>
	<source detector="100" id="73"/>
	<source detector="100" id="78"/>
	<source detector="100" id="79"/>
	<source detector="100" id="60"/>
	<source detector="100" id="44"/>
	<source detector="100" id="43"/>
	<source detector="100" id="113"/>
	<!-- Layer id = 48 (49 for laurent) -->
	<!-- <source detector="100" id="66"/> -->
	<!-- <source detector="100" id="69"/> -->
	<!-- <source detector="100" id="68"/> -->
	<source detector="100" id="186"/>
	<source detector="100" id="127"/>
	<source detector="100" id="154"/>
	<source detector="100" id="147"/>
	<source detector="100" id="70"/>
	<source detector="100" id="71"/>
	<source detector="100" id="47"/>
	<source detector="100" id="139"/>
	<source detector="100" id="140"/>
	<source detector="100" id="143"/>
	<source detector="100" id="77"/>
	<source detector="100" id="76"/>
	<source detector="100" id="159"/>
	<source detector="100" id="91"/>
	<source detector="100" id="36"/>
	<source detector="100" id="179"/>
	<source detector="100" id="178"/>
	<source detector="100" id="183"/>
	<source detector="100" id="41"/>
	<source detector="100" id="42"/>
	<source detector="100" id="67"/>
	<source detector="100" id="137"/>
	<source detector="100" id="46"/>
	<source detector="100" id="138"/>
	<source detector="100" id="131"/>
	<source detector="100" id="173"/>
	<source detector="100" id="144"/>
	<source detector="100" id="189"/>
	<source detector="100" id="184"/>
	<source detector="100" id="160"/>
	<source detector="100" id="172"/>
	<source detector="100" id="167"/>
	<source detector="100" id="171"/>
	<source detector="100" id="146"/>
	<source detector="100" id="135"/>
	<source detector="100" id="145"/>
	<source detector="100" id="185"/>
	<source detector="100" id="170"/>
	<source detector="100" id="180"/>
	<source detector="100" id="187"/>
	<source detector="100" id="188"/>
	<source detector="100" id="190"/>
	<source detector="100" id="169"/>
	<source detector="100" id="165"/>
	<source detector="100" id="166"/>
	<source detector="100" id="155"/>
	<source detector="100" id="57"/>
	<source detector="100" id="50"/>
	<source detector="100" id="153"/>
	<source detector="100" id="108"/>
	<source detector="100" id="25"/>
	<source detector="100" id="51"/>
	<source detector="100" id="56"/>
	<source detector="100" id="109"/>
	<source detector="100" id="107"/>
	<source detector="100" id="150"/>
	<!-- <source detector="100" id="116"/> -->
	<source detector="100" id="126"/>
	<source detector="100" id="124"/>
	<source detector="100" id="49"/>
	<source detector="100" id="174"/>
	<source detector="100" id="175"/>
	<source detector="100" id="176"/>
	<source detector="100" id="48"/>
	<source detector="100" id="45"/>
	<source detector="100" id="114"/>
	<source detector="100" id="98"/>
	<source detector="100" id="93"/>
	<source detector="100" id="40"/>
	<source detector="100" id="92"/>
	<source detector="100" id="97"/>
	<source detector="100" id="100"/>
	<source detector="100" id="62"/>
	<source detector="100" id="106"/>
	<source detector="100" id="132"/>
	<source detector="100" id="101"/>
	<source detector="100" id="35"/>
	<source detector="100" id="99"/>
	<source detector="100" id="158"/>
	<source detector="100" id="142"/>
	<source detector="100" id="141"/>
	<source detector="100" id="163"/>
	<source detector="100" id="161"/>
	<source detector="100" id="162"/>
	<source detector="100" id="104"/>
	<source detector="100" id="29"/>
	<source detector="100" id="112"/>
	<source detector="100" id="59"/>
	<source detector="100" id="53"/>
	<source detector="100" id="54"/>
	<source detector="100" id="96"/>
	<source detector="100" id="90"/>
	<source detector="100" id="27"/>
	<source detector="100" id="95"/>
	<source detector="100" id="8"/>
	<source detector="100" id="5"/>
	<source detector="100" id="63"/>
	<source detector="100" id="87"/>
	<source detector="100" id="18"/>

	<!-- Layer id = 49 (50 for laurent) -->
	<source detector="100" id="105"/>
	<source detector="100" id="182"/>
	<source detector="100" id="80"/>
	
	<source detector="100" id="243"/>
	<source detector="100" id="242"/>
	<source detector="100" id="241"/>

	<!-- Additional layers -->
	<!-- <source detector="100" id="205"/> -->
	<!-- <source detector="100" id="206"/> -->
	<!-- <source detector="100" id="207"/> -->
	<!-- <source detector="100" id="208"/> -->
	<!-- <source detector="100" id="209"/> -->
	<!-- <source detector="100" id="210"/> -->
	<!-- <source detector="100" id="211"/> -->
	<!-- <source detector="100" id="212"/> -->
	<!-- <source detector="100" id="213"/> -->
	<!-- <source detector="100" id="214"/> -->
	<!-- <source detector="100" id="215"/> -->
	<!-- <source detector="100" id="216"/> -->

	<!-- SiWECal sources (6 DIFs) -->
	<!-- <source detector="1100" id="1" /> -->
	<!-- <source detector="1100" id="2" /> -->
	<!-- <source detector="1100" id="3" /> -->
	<!-- <source detector="1100" id="4" /> -->
	<!-- <source detector="1100" id="5" /> -->
	<!-- <source detector="1100" id="6" /> -->
	<!-- <source detector="1100" id="7" /> -->
	<!-- <source detector="1100" id="8" /> -->
	<!-- <source detector="1100" id="9" /> -->

      </datasources>
    </shmdriver>

    <!-- Run control client to receive start/end of run signals -->
    <runcontrol plugin="DimRunControlClient" name="DQMRunControl" />

    <!-- Event clients to send data to event collector -->
    <eventclientlist>
      <eventclient plugin="DimEventClient">
	<parameter name="collectorName"> event_collector </parameter>
      </eventclient>
      <eventclient plugin="DimEventClient">
	<parameter name="collectorName"> event_collector_2 </parameter>
      </eventclient>
    </eventclientlist>

    <!-- The event streamer to serialize data for event client -->
    <eventstreamer plugin="LCIOStreamer" />

    <!-- Event builder processor. Fill an event from the shm driver data source 
	 buffers -->
    <evbprocessors>
      <evbprocessor name="EventInfoProducer" />
      <!-- <evbprocessor name="SiWECalProducer" /> -->
      <evbprocessor name="SDHCALProducer" />
      <!-- <evbprocessor name="CherenkovProducer"/> -->
      <!-- <evbprocessor name="LcioFileWriter" /> -->
    </evbprocessors>

  </global>


  <!-- Event builder processors configuration -->
  <evbprocessors>

    <!-- Event lcio collection producer -->
    <!-- Output EVENT::RawCalorimeterHit collection -->
    <evbprocessor plugin="EventInfoShmProcessor" name="EventInfoProducer">
      <parameter name="CreationTimeParameterName"> CREATION_TIME </parameter>
    </evbprocessor>


        <!-- SDHCAL lcio collection producer -->
    <!-- Output CalorimeterHit collection -->
    <evbprocessor plugin="SDHCALShmProcessor" name="SDHCALProducer">
      <parameter name="OutputCollectionName"> SDHCAL_HIT </parameter>
      <parameter name="SkipFullAsics"> true </parameter>
      <parameter name="DropFirstRU"> true </parameter>
      <parameter name="NoiseLimit"> 400000 </parameter>
      <parameter name="XDaqShift"> 20 </parameter>
      <parameter name="DetectorId"> 100 </parameter>
      <parameter name="DifMaskList"> 3 </parameter>
      <electronicsMapping plugin="SDHCALElectronicsMapping">
	<!-- * X shift = 712 (ecal to hcal 0 shift) - 193.2 (shift to ecal center) 
	     = 518.8 mm 
	     * Y shift = 703 (ecal to hcal 0 shift) - 105.8 (shift to ecal 
	     center) = 597.2 mm 
	     * Z shift = 50 (ecal to hcal 0 shift) + 195.0 (ecal total 
	     lenght) + 22.1 (distance from hcal front face to first cell slice) + 1000 
	     (global additional shift) = 1167.1 mm 
	-->
	<parameter name="CellReferencePosition"> 511.8 674.2 1561.1 </parameter>
	<!-- <parameter name="CellReferencePosition"> 518.8 597.2 1267.1 </parameter> -->
	<parameter name="CellSize0"> 10.408f </parameter>
	<parameter name="CellSize1"> 10.408f </parameter>
	<parameter name="ReadFromDB"> false </parameter>
	<parameter name="Host"> localhost </parameter>
	<parameter name="User"> rete </parameter>
	<parameter name="Password">
	</parameter>
	<parameter name="Database"> GEOMETRY </parameter>
	<parameter name="BeamTest"> SPS_08_2012 </parameter>
	<!-- <parameter name="GeometryFileName"> /home/rete/soft/DQMSDHCAL/config/geometry_SPS_08_2012.xml 
	     </parameter> -->
	     <parameter name="GeometryFileName"> /home/rete/soft/DQMSDHCAL/config/geometry_PS_06_2015.xml </parameter>
      </electronicsMapping>
      <parameter name="AmplitudeBitRotation"> 3 </parameter>
      <parameter name="EncodeDifAsicChannel"> true </parameter>
      <parameter name="IJKEncoding"> I J K-1 </parameter>
      <parameter name="DifAsicChannelEncoding"> Dif_id Asic_id Chan_id </parameter>
      <parameter name="CellIDEncoderString"> I:7,J:7,K-1:6,Dif_id:8,Asic_id:8,Chan_id:6 </parameter>
    </evbprocessor>

    <!-- SiWECal lcio collection producer -->
    <!-- Output EVENT::CalorimeterHit and EVENT::RawCalorimeterHit collections -->
    <evbprocessor plugin="SiWECalShmProcessor" name="SiWECalProducer">
      <parameter name="OutputCollectionName"> SIWECAL_HIT </parameter>
      <parameter name="OutputRawCollectionName"> SiWECalHits </parameter>
      <parameter name="DetectorId"> 1100 </parameter>
      <!-- * X shift = 193.2 mm (shift to ecal center) 
	   * Y shift = 105.8 mm (shift to ecal center) 
	   * Z shift = 195.0 (ecal total lenght)
	   + 1000 (global additional shift) 
	   = 1195 mm 
      -->
      <parameter name="PositionShift"> -193.2 -105.8 1195 </parameter>
      <parameter name="IJKEncoding"> I J K-1 </parameter>
      <parameter name="DifAsicChannelEncoding"> Dif_id Asic_id Chan_id </parameter>
      <parameter name="CellIDEncoderString"> I:7,J:7,K-1:6,Dif_id:8,Asic_id:8,Chan_id:6 </parameter>
      <parameter name="EnergyMode">3</parameter>
      <parameter name="AdcCountCut">0</parameter>
      <parameter name="NegativeAdcCountSuppression">true</parameter>
      <ecalHelper>
	<parameter name="HardwareLayerMapping"> 
	  8 0   
	  7 1   
	  6 2  
	  5 3  
	  4 4   
	  3 5   
	  2 6   
	  1 7   
	  0 8   
	  -1 9
	</parameter>				
	<parameter name="SlabMapping">
	  -1 13
	  0 14
	  1 22
	  2 21
	  3 20
	  4 19
	  5 18
	  6 17
	  7 16
	  8 15
	</parameter>
	<parameter name="NColumns"> 15 </parameter>
	<parameter name="PedestalShift"> 250 </parameter>
	<parameter name="PedestalRootFileName"> /home/rete/soft/DQMSDHCAL/config/SiWECal_SDHCAL_SPS_06_2016/SiWECalPedestals/SLAB${id}.raw_pedestal.root </parameter>
	<parameter name="CorrectedPedestalCut"> 20 </parameter>
	<parameter name="MipCalibrationFactor"> 60 </parameter>
	<parameter name="MipEquivalentEnergy"> 0.0012715 </parameter>
      </ecalHelper>
    </evbprocessor>


    
    <!--Cherenkov lcio collection producer -->
    <!-- Output CalorimeterHit collection -->
    <evbprocessor plugin="CherenkovShmProcessor" name="CherenkovProducer">
      <parameter name="OutputCollectionName"> CHERENKOV_HIT </parameter>
      <parameter name="CherenkovDifId"> 3 </parameter>
      <parameter name="XDaqShift"> 20 </parameter>
      <parameter name="DetectorId"> 100 </parameter>
    </evbprocessor>

    <!-- Lcio file writer. Save data to disk for further analysis -->
    <evbprocessor plugin="FileWriterShmProcessor" name="LcioFileWriter">
      <parameter name="FileDirectory"> /data/NAS/June2016/DQMData/ </parameter>
      <parameter name="FileName"> DQM_SiWECal_SDHCAL </parameter>
      <parameter name="OpenMode"> 1 </parameter>
      <parameter name="CompressionLevel"> 2 </parameter>
    </evbprocessor>

  </evbprocessors>

</dqm4hep>
